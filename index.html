<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 诊断辅助系统</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 强制使用 Inter 字体，提供更好的可读性 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* 隐藏加载时的占位符，直到 JS 完成初始化 */
        [data-i18n]:empty {
            min-width: 50px; /* 避免布局晃动 */
            min-height: 1.5em;
            display: inline-block;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <!-- Header and Language Selector -->
        <header class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800" data-i18n="appTitle">AI 诊断辅助系统</h1>
            
            <!-- Language Selector -->
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600" data-i18n="selectLanguage">Select Language:</span>
                <select id="language-selector" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="en">English</option>
                    <option value="zh">中文 (Chinese)</option>
                </select>
            </div>
        </header>

        <!-- Main Form and Input Area -->
        <section class="mb-8">
            <label for="medical-history" class="block text-xl font-semibold text-gray-700 mb-3" data-i18n="historyLabel">患者病史与检验结果:</label>
            <textarea id="medical-history" rows="2" class="w-full p-4 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-500 focus:border-blue-500 resize-y min-h-[100px]" 
                      placeholder="请在此处输入详细的患者病史、症状、体征以及任何实验室或影像学检验结果...">
            </textarea>
            <div id="apiError" class="text-red-600 font-medium mt-3 hidden" data-i18n="apiErrorInitial"></div>
        </section>

        <!-- Demo Cases -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold text-gray-700 mb-2" data-i18n="demoCasesTitle">演示案例:</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="loadDemo('demo1')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors text-sm" data-i18n="demo1">案例 1: 阑尾炎</button>
                <button onclick="loadDemo('demo2')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors text-sm" data-i18n="demo2">案例 2: 肺炎</button>
                <button onclick="loadDemo('demo3')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors text-sm" data-i18n="demo3">案例 3: 肾结石</button>
                <button onclick="loadDemo('demo4')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors text-sm" data-i18n="demo4">案例 4: 糖尿病</button>
            </div>
        </section>

        <!-- Action Button -->
        <div class="flex justify-center mb-8">
            <button id="analyze-button" onclick="runAnalysis()" 
                    class="px-12 py-3 bg-blue-600 text-white font-bold rounded-full text-lg shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:transform-none"
                    data-i18n="analyzeButton">
                运行 AI 分析
            </button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="hidden text-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-gray-600" data-i18n="loadingMessage">AI 正在分析数据，请稍候...</p>
        </div>

        <!-- Results Display Area -->
        <div id="results-display" class="hidden mt-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
            <h2 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2" data-i18n="resultsTitle">分析结果</h2>

            <!-- Medical Analysis Section -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-3" data-i18n="analysisSectionTitle">AI 医疗分析 (初步诊断与鉴别诊断):</h3>
                <div id="medical-analysis-content" class="p-4 bg-white border border-gray-200 rounded-lg text-gray-700 leading-relaxed whitespace-pre-wrap">
                    <!-- Analysis content will be inserted here -->
                </div>
            </div>

            <!-- IVD Recommendations Section -->
            <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3" data-i18n="ivdSectionTitle">体外诊断 (IVD) 检验建议:</h3>
                <ul id="ivd-recommendations-list" class="list-disc list-inside space-y-2 p-4 bg-white border border-gray-200 rounded-lg text-gray-700">
                    <!-- IVD recommendations will be inserted here -->
                </ul>
            </div>
            
            <p class="mt-6 text-sm text-yellow-700 bg-yellow-100 p-3 rounded-lg border border-yellow-300" data-i18n="disclaimer">
                **免责声明：** 本系统提供的分析仅供参考，不能替代专业医生的诊断。请务必咨询合格的医疗专业人员以获得准确的诊断和治疗建议。
            </p>
        </div>
    </div>

    <script>
        // --- Internationalization (I18N) Dictionary ---
        const translations = {
            en: {
                appTitle: "AI Diagnostic Assistant",
                selectLanguage: "Select Language:",
                historyLabel: "Patient History and Test Results:",
                analyzeButton: "Run AI Analysis",
                loadingMessage: "AI is analyzing data, please wait...",
                resultsTitle: "Analysis Results",
                analysisSectionTitle: "AI Medical Analysis (Preliminary/Differential Diagnosis):",
                ivdSectionTitle: "In Vitro Diagnostics (IVD) Test Recommendations:",
                disclaimer: "**Disclaimer:** The analysis provided by this system is for reference only and cannot replace professional medical diagnosis. Always consult a qualified healthcare professional for accurate diagnosis and treatment.",
                apiErrorInitial: "AI analysis failed. Please check the inputs or try again later. (Details: API request failed with status)",
                demoCasesTitle: "Demo Cases:",
                demo1: "Case 1: Appendicitis",
                demo2: "Case 2: Pneumonia",
                demo3: "Case 3: Kidney Stones",
                demo4: "Case 4: Diabetes",
                historyPlaceholder: "Please enter detailed patient history, symptoms, signs, and any lab or imaging test results here..."
            },
            zh: {
                appTitle: "AI 诊断辅助系统",
                selectLanguage: "选择语言:",
                historyLabel: "患者病史与检验结果:",
                analyzeButton: "运行 AI 分析",
                loadingMessage: "AI 正在分析数据，请稍候...",
                resultsTitle: "分析结果",
                analysisSectionTitle: "AI 医疗分析 (初步诊断与鉴别诊断):",
                ivdSectionTitle: "体外诊断 (IVD) 检验建议:",
                disclaimer: "**免责声明：** 本系统提供的分析仅供参考，不能替代专业医生的诊断。请务必咨询合格的医疗专业人员以获得准确的诊断和治疗建议。",
                apiErrorInitial: "AI分析失败。请检查输入或稍后重试。（详情：API request failed with status）",
                demoCasesTitle: "演示案例:",
                demo1: "案例 1: 阑尾炎",
                demo2: "案例 2: 肺炎",
                demo3: "案例 3: 肾结石",
                demo4: "案例 4: 糖尿病",
                historyPlaceholder: "请在此处输入详细的患者病史、症状、体征以及任何实验室或影像学检验结果..."
            }
        };

        const demoData = {
            demo1: "症状: 25岁男性，右下腹痛持续24小时，伴有恶心、呕吐，体温38.5°C。体格检查示右下腹McBurney点压痛、反跳痛。实验室检查: WCC 18,000/μL (中性粒细胞比例高)。",
            demo2: "症状: 68岁女性，持续咳嗽、咳痰、发热三天，伴有呼吸困难。听诊右下肺可闻及湿啰音。胸片示右下肺实变影。实验室检查: CRP 120 mg/L。",
            demo3: "症状: 40岁男性，突发剧烈右侧腰腹部绞痛，向下腹部和腹股沟放射，伴有血尿。患者自述无发热。尿液分析: 镜下血尿。",
            demo4: "症状: 55岁女性，近三个月来多饮、多尿、体重减轻。空腹血糖 15.5 mmol/L (正常值 < 6.1)。HbA1c 9.8% (正常值 < 6.5%)。"
        };

        let currentLang = 'zh';

        // --- I18N Functions ---
        function applyTranslation(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            // Update placeholder text
            document.getElementById('medical-history').placeholder = translations[lang].historyPlaceholder;
            // Update API Error initial message if visible
            const errorElement = document.getElementById('apiError');
            if (errorElement.textContent === translations['en'].apiErrorInitial || errorElement.textContent === translations['zh'].apiErrorInitial) {
                 errorElement.textContent = translations[lang].apiErrorInitial;
            }
        }

        function initializeLanguage() {
            const selector = document.getElementById('language-selector');
            // Set initial language based on the HTML tag
            const initialLang = document.documentElement.lang || 'zh';
            if (translations[initialLang]) {
                selector.value = initialLang;
                applyTranslation(initialLang);
            } else {
                applyTranslation('zh'); // Default to Chinese
            }

            selector.addEventListener('change', (e) => {
                document.documentElement.lang = e.target.value;
                applyTranslation(e.target.value);
            });
        }

        // --- Utility Functions ---

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = `${translations[currentLang].apiErrorInitial.split('（详情')[0]}（详情: ${message}）`;
            errorElement.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('apiError').classList.add('hidden');
        }

        function loadDemo(demoKey) {
            const historyTextarea = document.getElementById('medical-history');
            historyTextarea.value = demoData[demoKey];
            hideError();
            document.getElementById('results-display').classList.add('hidden');
        }

        // --- Main Analysis Logic (MODIFIED FOR BETTER ERROR REPORTING) ---

        async function runAnalysis() {
            const historyInput = document.getElementById('medical-history').value.trim();
            const analyzeButton = document.getElementById('analyze-button');
            const loading = document.getElementById('loading');
            const resultsDisplay = document.getElementById('results-display');
            
            hideError();
            resultsDisplay.classList.add('hidden');

            if (!historyInput) {
                showError('apiError', 'History input is required.');
                return;
            }

            analyzeButton.disabled = true;
            loading.classList.remove('hidden');

            const systemPrompt = "你是一位经验丰富的医疗诊断辅助AI。你的任务是根据提供的患者病史、症状和检验结果，进行初步诊断、鉴别诊断，并推荐相关的体外诊断（IVD）检验项目。请以JSON格式输出，包含两个键：'medicalAnalysisText'（详细的医疗分析文本，包括初步诊断和鉴别诊断）和'ivdRecommendations'（一个推荐IVD检验项目的列表，仅包含项目名称）。请确保输出严格符合JSON格式，并且是唯一的JSON对象，不要包含任何额外的解释性文本。";
            const userPrompt = `请对以下患者信息进行分析：\n\n${historyInput}`;

            try {
                // 1. Send request to the Vercel AI Proxy
                const response = await fetch('/api/ai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ]
                    })
                });

                // --- NEW ROBUST ERROR CHECKING ---
                if (!response.ok) {
                    const errorText = await response.text(); 
                    let detailMessage = `HTTP 状态码: ${response.status}`;
                    // Attempt to parse JSON error body for more info
                    try {
                        const errorJson = JSON.parse(errorText);
                        // Try to find common error keys, otherwise fall back to raw text
                        detailMessage += ` | 详情: ${errorJson.error || errorJson.message || errorText.substring(0, 200)}`;
                    } catch {
                        // If not JSON, show the raw text snippet
                        detailMessage += ` | 详情: ${errorText.substring(0, 200)}`;
                    }
                    // Throw a detailed error for the catch block to handle
                    throw new Error(detailMessage);
                }
                // --- END NEW ROBUST ERROR CHECKING ---

                // 2. Process response
                const data = await response.json();
                
                // 3. Parse and validate JSON structure
                const { medicalAnalysisText, ivdRecommendations } = data;
                
                if (!medicalAnalysisText || !ivdRecommendations || !Array.isArray(ivdRecommendations)) {
                     throw new Error("AI response format error: Missing expected fields or ivdRecommendations is not an array.");
                }

                // 4. Populate results
                document.getElementById('medical-analysis-content').textContent = medicalAnalysisText;
                
                const ivdListElement = document.getElementById('ivd-recommendations-list');
                ivdListElement.innerHTML = ''; // Clear old list
                ivdRecommendations.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.className = 'ml-4'; // Add some left margin for better list display
                    ivdListElement.appendChild(li);
                });

                // 5. Display results
                loading.classList.add('hidden');
                resultsDisplay.classList.remove('hidden');

            } catch (error) {
                console.error("Analysis Error:", error);
                document.getElementById('medical-analysis-content').textContent = '';
                document.getElementById('ivd-recommendations-list').innerHTML = '';
                // Use the new, detailed error message
                showError('apiError', error.message.substring(0, 200)); 
            } finally {
                // 6. Final cleanup
                loading.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        window.onload = initializeLanguage;
    </script>
</body>
</html>
