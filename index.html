<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 诊断辅助系统</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 强制使用 Inter 字体，提供更好的可读性 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* 隐藏加载时的占位符，直到 JS 完成初始化 */
        [data-i18n]:empty {
            min-width: 50px; /* 避免布局晃动 */
            min-height: 1.5em;
            display: inline-block;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <!-- Header and Language Selector -->
        <header class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800" data-i18n="appTitle">AI Diagnostic Assistant</h1>
            
            <!-- Language Selector -->
            <div class="flex items-center space-x-2">
                <label for="language-select" class="text-sm font-medium text-gray-600" data-i18n="languageLabel">Language:</label>
                <select id="language-select" class="p-2 border border-gray-300 rounded-lg text-sm transition duration-150 ease-in-out hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="en">English</option>
                    <option value="zh">中文 (Chinese)</option>
                </select>
            </div>
        </header>

        <!-- Input Section -->
        <div id="input-section" class="space-y-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700" data-i18n="inputTitle">Patient Data Input</h2>
            
            <!-- Medical History Input -->
            <div>
                <label for="medical-history" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="historyLabel">Medical History, Symptoms, and Preliminary Findings:</label>
                <textarea id="medical-history" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="e.g., Patient is a 55-year-old male presenting with severe abdominal pain, high fever (103°F), and elevated white blood cell count (18,000/µL). No history of previous abdominal surgery."></textarea>
            </div>

            <!-- Pre-diagnosis Input -->
            <div>
                <label for="pre-diagnosis" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="diagnosisLabel">Doctor's Pre-Diagnosis/Differential Diagnosis:</label>
                <input type="text" id="pre-diagnosis" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="e.g., Acute appendicitis, diverticulitis, or bacterial gastroenteritis.">
            </div>

            <!-- Analyze Button -->
            <button id="analyze-button" onclick="runAnalysis()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-[1.01]" data-i18n="analyzeButton">
                Run AI Analysis
            </button>
            
            <!-- Error Message Display -->
            <div id="error-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
                <span id="error-content"></span>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="hidden text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium" data-i18n="loadingMessage">Analyzing data... This may take a moment.</p>
        </div>

        <!-- Results Display Section -->
        <div id="results-display" class="hidden space-y-8 mt-8 border-t pt-8">
            <h2 class="text-2xl font-semibold text-gray-700" data-i18n="resultsTitle">AI Diagnosis and IVD Recommendations</h2>

            <!-- Medical Analysis Card -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.27a11.97 11.97 0 010 17.156A11.97 11.97 0 0112 21c-2.47 0-4.85-.756-6.866-2.184l-2.121 2.121a1 1 0 01-1.414-1.414l2.121-2.121A11.97 11.97 0 013 12c0-2.47.756-4.85 2.184-6.866l-2.121-2.121a1 1 0 011.414-1.414l2.121 2.121C7.15 4.75 9.53 4 12 4c2.47 0 4.85.756 6.866 2.184l2.121-2.121a1 1 0 011.414 1.414l-2.121 2.121z" />
                    </svg>
                    <span data-i18n="analysisHeader">Medical Analysis:</span>
                </h3>
                <p id="medical-analysis-content" class="text-gray-600 leading-relaxed whitespace-pre-wrap"></p>
            </div>

            <!-- IVD Recommendations Card -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4v2m-4 0v2" />
                    </svg>
                    <span data-i18n="ivdHeader">IVD Recommendations (Prioritized In-Vitro Diagnostic Tests):</span>
                </h3>
                <ul id="ivd-recommendations-list" class="list-disc pl-5 text-gray-600 space-y-2">
                    <!-- List items will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- 1. LANGUAGE AND TRANSLATION ---
        const translations = {
            en: {
                appTitle: "AI Diagnostic Assistant",
                languageLabel: "Language:",
                inputTitle: "Patient Data Input",
                historyLabel: "Medical History, Symptoms, and Preliminary Findings:",
                diagnosisLabel: "Doctor's Pre-Diagnosis/Differential Diagnosis:",
                analyzeButton: "Run AI Analysis",
                loadingMessage: "Analyzing data... This may take a moment.",
                resultsTitle: "AI Diagnosis and IVD Recommendations",
                analysisHeader: "Medical Analysis:",
                ivdHeader: "IVD Recommendations (Prioritized In-Vitro Diagnostic Tests):",
                apiError: "AI analysis failed. Please check the inputs or try again later.",
                apiError502: "Connection Error (502). Please ensure your secure proxy is deployed and your OpenAI API Key is correctly set in Vercel's environment variables."
            },
            zh: {
                appTitle: "AI 诊断辅助系统",
                languageLabel: "语言:",
                inputTitle: "患者资料输入",
                historyLabel: "病史、症状和初步发现:",
                diagnosisLabel: "医生初步诊断/鉴别诊断:",
                analyzeButton: "运行AI分析",
                loadingMessage: "正在分析数据... 请稍候。",
                resultsTitle: "AI诊断与IVD建议",
                analysisHeader: "医学分析:",
                ivdHeader: "IVD建议 (优先体外诊断检测):",
                apiError: "AI分析失败。请检查输入或稍后重试。",
                apiError502: "连接错误 (502)。请确保您的安全代理已部署，并且您的OpenAI API Key已在Vercel的环境变量中正确设置。"
            }
        };

        let currentLanguage = 'en';

        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });

            // Update placeholders manually
            document.getElementById('medical-history').placeholder = currentLanguage === 'zh' 
                ? "例如: 患者为55岁男性，主诉剧烈腹痛、高烧 (39.4°C) 和白细胞计数升高 (18,000/µL)。无既往腹部手术史。" 
                : "e.g., Patient is a 55-year-old male presenting with severe abdominal pain, high fever (103°F), and elevated white blood cell count (18,000/µL). No history of previous abdominal surgery.";
            document.getElementById('pre-diagnosis').placeholder = currentLanguage === 'zh' 
                ? "例如: 急性阑尾炎、憩室炎或细菌性胃肠炎。" 
                : "e.g., Acute appendicitis, diverticulitis, or bacterial gastroenteritis.";
        }

        function initializeLanguage() {
            // Set initial language from HTML or default to 'en'
            currentLanguage = document.documentElement.lang || 'en';
            document.getElementById('language-select').value = currentLanguage;
            applyTranslations();

            document.getElementById('language-select').addEventListener('change', (e) => {
                currentLanguage = e.target.value;
                document.documentElement.lang = currentLanguage;
                applyTranslations();
                // Clear errors on language change
                document.getElementById('error-message').classList.add('hidden');
            });
        }

        function showError(key, details = '') {
            const errorElement = document.getElementById('error-message');
            const contentElement = document.getElementById('error-content');
            
            let message = translations[currentLanguage][key] || translations['en'][key];
            
            // Check for 502 error and append specific message
            if (key === 'apiError' && details.includes('502')) {
                message = translations[currentLanguage].apiError502 || translations['en'].apiError502;
            } else if (key === 'apiError' && details) {
                // For other errors, append details if available and safe
                message += ` (Details: ${details.split(':')[0]})`;
            }

            contentElement.textContent = message;
            errorElement.classList.remove('hidden');
        }


        // --- 2. API CALL AND ANALYSIS ---

        async function runAnalysis() {
            const historyInput = document.getElementById('medical-history').value.trim();
            const preDiagnosisInput = document.getElementById('pre-diagnosis').value.trim();
            
            const analyzeButton = document.getElementById('analyze-button');
            const loading = document.getElementById('loading');
            const resultsDisplay = document.getElementById('results-display');
            const errorMessage = document.getElementById('error-message');

            // 0. Clear previous results and errors
            resultsDisplay.classList.add('hidden');
            errorMessage.classList.add('hidden');
            document.getElementById('medical-analysis-content').textContent = '';
            document.getElementById('ivd-recommendations-list').innerHTML = '';

            if (!historyInput) {
                showError('apiError', 'History input is required.');
                return;
            }

            // 1. Prepare UI for analysis
            analyzeButton.disabled = true;
            loading.classList.remove('hidden');

            const systemPrompt = `You are a world-class AI medical consultant specializing in in-vitro diagnostics (IVD). Your task is to analyze patient data and a pre-diagnosis. 
            You must provide a structured, two-part response in ${currentLanguage === 'zh' ? 'Chinese' : 'English'}.
            Your response MUST be a single JSON object matching the following schema:
            {
                "medicalAnalysis": "A detailed, paragraph-based analysis confirming or adjusting the pre-diagnosis based on the symptoms and findings. Explain your reasoning and list possible complications.",
                "ivdRecommendations": ["A prioritized list of 3-5 specific in-vitro diagnostic tests (e.g., 'C-reactive protein (CRP) test', 'D-dimer assay') necessary to confirm the diagnosis or rule out differential diagnoses."]
            }`;
            
            const userPrompt = `
            Patient Data/Symptoms: ${historyInput}
            Doctor's Pre-Diagnosis/Differential Diagnosis: ${preDiagnosisInput}
            `;

            try {
                // VERCEL PATH: The request is now sent to the Vercel Serverless Function endpoint: /api/ai-proxy
                const proxyUrl = '/api/ai-proxy';
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ]
                    })
                });

                // 2. Handle HTTP errors from the proxy (e.g., 500, 502)
                if (!response.ok) {
                    const errorDetails = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(`API request failed with status: ${response.status}. Details: ${errorDetails.error}`);
                }

                // 3. Process the AI response
                const data = await response.json();
                
                // Extract the AI's JSON string from the response
                const aiResponseJsonString = data.choices[0].message.content;
                const aiResponse = JSON.parse(aiResponseJsonString);

                const medicalAnalysisText = aiResponse.medicalAnalysis;
                const ivdRecommendations = aiResponse.ivdRecommendations;

                if (!medicalAnalysisText || !ivdRecommendations || !Array.isArray(ivdRecommendations)) {
                     throw new Error("Missing expected fields in AI response JSON.");
                }


                // 4. Populate results
                document.getElementById('medical-analysis-content').textContent = medicalAnalysisText;
                
                const ivdListElement = document.getElementById('ivd-recommendations-list');
                ivdListElement.innerHTML = ''; // Clear old list
                ivdRecommendations.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.className = 'text-gray-700';
                    ivdListElement.appendChild(li);
                });

                // 5. Display results
                loading.classList.add('hidden');
                resultsDisplay.classList.remove('hidden');

            } catch (error) {
                console.error("Analysis Error:", error);
                document.getElementById('medical-analysis-content').textContent = '';
                document.getElementById('ivd-recommendations-list').innerHTML = '';
                // Check if the error is a 502 and use the specific translation
                const errorMessage = error.message;
                if (errorMessage.includes('502')) {
                    showError('apiError', '502'); // Trigger 502 specific message
                } else {
                    showError('apiError', errorMessage); 
                }
            } finally {
                // 6. Final cleanup
                analyzeButton.disabled = false;
            }
        }

        window.onload = initializeLanguage;
    </script>
</body>
</html>
